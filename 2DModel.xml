<mujoco model="finger with orthotic">
    <option timestep="0.005" iterations="50" solver="Newton" tolerance="1e-8" integrator="Euler">
        <flag gravity="disable" contact="disable" energy="enable"/>
    </option>

    <compiler angle="degree"/>

    <visual>
        <rgba haze=".3 .3 .3 1"/>
    </visual>

    <default>
        <joint type="hinge" pos="0 0 0" axis="0 0 1"/>
        <site size="0.06" rgba="1 0 0 .2"/>
        <geom type="capsule" size="0.01" rgba=".1 .1 .1 1"/>
        <tendon width="0.01" rgba="0 1 1 1"/>
    </default>

    <asset>
        <texture type="skybox" builtin="gradient" rgb1="0.6 0.6 0.6" rgb2="0 0 0" width="512" height="512"/>
        <texture name="texplane" type="2d" builtin="checker" rgb1=".25 .25 .25" rgb2=".3 .3 .3" width="512" height="512" mark="cross" markrgb=".8 .8 .8"/>
        <material name="matplane" reflectance="0.3" texture="texplane" texrepeat="1 1" texuniform="true"/>
    </asset>

    <worldbody>
        <light directional="true" diffuse=".8 .8 .8" specular=".2 .2 .2" pos="0 0 5" dir="0 0 -1"/>
        <camera name="cam" pos="0 0 -1.2" xyaxes="1.000 0 0 0 -1.000 0" />

        <body name="finger" pos="0 0 0">
            <geom name="finger1" type="capsule" size="0.06" fromto="0 0 0  -.25 0 0" rgba=".5 .1 .1 1"/>
            <site name="sPIPL" pos="-.1 0 0" size="0.12"/>

            <body pos="0 0 0">
                <geom name="finger2" type="capsule" size="0.05" fromto="0 0 0  .25 0 0" rgba=".5 .1 .1 1"/>
                <joint name="PIP" pos="0 0 0" stiffness="0" damping="0"/>
                <site name="sPIPR" pos=".1 0 0" size="0.12"/>
                
                <body pos=".25 0 0">
                    <geom name="finger3" type="capsule" size="0.04" fromto="0 0 0  .25 0 0" rgba=".5 .1 .1 1"/>
                </body>
            </body>
        </body>

        <body name="orthosis" pos="0 0 -.1">
            <geom name="beamB" type="capsule" size="0.04" fromto="0 0 0  -.42 0 0" />
            <site name="hBAL" pos="-.1 0 0" size="0.06"/>
            
            <body name ="Bnext" pos="0 0 0">
                <joint name="hingeBA" type="hinge" pos="0 0 0" axis="0 0 1"/>        
                <site name="hBAR" pos=".1 0 0" size="0.06"/>
                <geom name="beamA" type="capsule" size="0.04" fromto="0 0 0  0.5 0 0" />
                
                <body name ="Anext" pos="0.5 0 0">
                    <joint name="hingeAL" type="hinge" pos="0 0 0" axis="0 0 1"/>      
                    <geom name="smallBodyAL" type="sphere" size="0.04" pos="0 0 0"/>
                    <site name="hAL" pos="0 0 0" size="0.06"/>
                </body>     
            </body>
            
            <geom name="beamD" type="capsule" size="0.04" fromto="-.42 0 0  -.2 -0.25 0" />
            <body name ="Dnext" pos = "-.2 -0.25 0">
                <joint name="hingeDL" type="hinge" pos="0 0 0" axis="0 0 -1"/>
                <geom name="smallBodyDL" type="sphere" size="0.04" pos="0 0 0"/>
                <site name="hDL" pos="0 0 0" size="0.06"/>
            </body> 
        </body>
    </worldbody>

    <equality>
        <!-- <weld site1="hBAL" site2="sPIPL"/> -->
        <weld site1="hBAR" site2="sPIPR"/>  
        <!-- solref (timeconst,dampratio)  solref="0 1" 
        Time constant: Represents how quickly the constraint resolves a violation. Larger values mean the system is softer.
        The lowest is 2*timestep.
        Damping ratio: Typically set to 1 for critical damping; lower values lead to bouncier (underdamped) responses.-->
    </equality>

    <!-- If the tendon length is between the two values, the force is 0. If it is outside this range, 
    the force behaves like a regular spring, with the rest-point corresponding to the nearest springlength value.  -->
    <!-- limited="true" range="0 0.95" solimplimit="0.001 0.001 0.001 0.5 1" solreflimit="-100 -0"  -->
    <tendon>
        <spatial name="bendingTendon" limited="true" range="0.5314167955265112 2" width="0.1" solimplimit="0.001 0.001 0.001 0.5 1" solreflimit="-1000 -10">
            <site site="hDL"/>
            <site site="hAL"/>
        </spatial>
        <!-- add extension resistance -->
        <!-- <spatial name="extensionTendon" springlength="0 0.5314167955265112" width="0.01" stiffness="10000" damping="1000" solreflimit="-10000 -0" solimplimit="0.001 0.001 0.001 0.5 2"> -->
        <!-- solreflimit [-stiffness -damping] damping should be 0-->
        <!-- <spatial name="extensionTendon" springlength="0 0.5314167955265112" width="0.01" stiffness="10000" damping="1000" solreflimit="-10000 -0" solimplimit="0.001 0.001 0.001 0.5 2"> -->
        <spatial name="extensionTendon" limited="true" range="0 0.5314167955265112" width="0.1" solimplimit="0.001 0.001 0.001 0.5 1" solreflimit="-10000 -0" >    
            <site site="hDL" />
            <site site="hAL" />
        </spatial>
    </tendon>

    <actuator>
        <motor name="finger_bend" joint="PIP" ctrlrange="-10 10" gear="100"/>
    </actuator>

    <sensor>
        <force name="finger_force" site="sPIPR"/>
        <torque name="finger_torque" site="sPIPR"/>
        <force name="tendon_force" site="hDL"/>
    </sensor>
</mujoco>


<!-- note
joint & tendon
limit: r(q) is the distance between the current position/length and the closer of the two 
limiting values specified in range. The sign of this distance is automatically adjusted so that it is 
positive if the limit is not yet reached, zero at the limit, and negative if the limit is violated. 
The constraint becomes active when this distance falls below the “margin” parameter. 

A joint might be allowed to move within a certain range, but if it tries to go too far in one direction, 
a force is applied to push it back. 

stiffness: 
joint: a spring will be created with equilibrium position given by "springref". The spring force is computed along with the other passive forces.
tendon: A positive value generates a spring force (linear in position) acting along the tendon.
reflength of joint and spring: mjModel.qpos_spring
 -->